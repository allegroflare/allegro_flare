properties:


  - name: HEADER_LENGTH
    static: true
    const: true
    type: std::size_t
    init_with: 16
    getter: true
    
  - name: MAX_BODY_LENGTH
    static: true
    const: true
    type: std::size_t
    init_with: 512
    getter: true

  - name: MAGIC_HEADER_CHUNK
    static: true
    const: true
    type: std::string
    init_with: '"AFNM"'
    getter: true

  - name: data
    type: std::string
    getter: true
    init_with: "16+512, ' '"

  - name: body_length
    type: std::size_t
    getter: true
    setter: false
    init_with: 0


functions:


  - name: todo
    body: |
      // set guards for unexpected acces when header has not been encoded
      return;


  - name: data_ptr
    type: char*
    body: |
      return data.data();


  - name: body_ptr
    type: char*
    body: |
      return data.data() + HEADER_LENGTH;


  - name: length
    type: std::size_t
    body: |
       return HEADER_LENGTH + body_length;


  - name: set_body_length
    type: void
    parameters:
      - name: new_length
        type: std::size_t
        default_argument: 0
    guards: [ (!(new_length > MAX_BODY_LENGTH)) ]
    body: |
      body_length = new_length;
      return;


  - name: set_body
    type: void
    parameters:
      - name: content
        type: std::string
        default_argument: '""'
    guards: [ (!(content.size() > MAX_BODY_LENGTH)) ]
    body: |
      set_body_length(content.size());
      std::memcpy(data_ptr() + HEADER_LENGTH, content.c_str(), body_length);
      return;


  - name: get_header
    type: std::string
    body: |
      return data.substr(0, HEADER_LENGTH);


  - name: encode_header
    type: void
    body: |
       // header is in the following format:
       // 4 chars, special block with the characters "AFNM" for "AllegroFlare network message"
       // 4 chars, size of the data block in base62 (not base64) (with the lowercase first)
       // 4 chars, the first 4 characters of a hash. This hash is of the first 8 characters of the header
       // 4 chars, the first 4 characters of a hash of the whole body

       char header[16 + 1] = ""; // eeks, here "16" is used rather than HEADER_LENGTH because constexpr is not
                                 // supported in quintessence

       std::string first_8 = MAGIC_HEADER_CHUNK + body_size_base62();

       std::sprintf(header,    MAGIC_HEADER_CHUNK.c_str());
       std::sprintf(header+4,  body_size_base62().c_str());
       std::sprintf(header+8,  first_4_chars_hash_of(first_8).c_str());
       // TODO: add hash of body content
       std::sprintf(header+12, first_4_chars_hash_of().c_str());

       std::memcpy(data_ptr(), header, HEADER_LENGTH);
       return;
    body_dependency_symbols:
      - std::cout


  - name: first_4_chars_hash_of
    type: std::string
    parameters:
      - name: string_to_hash
        type: std::string
        default_argument: '""'
    body: |
      AllegroFlare::SHA2 sha2;
      return sha2.generate_sha224_hash(string_to_hash).substr(0, 4);
    body_dependency_symbols:
      - AllegroFlare::SHA2


  - name: body_size_base62
    type: std::string
    body: |
      AllegroFlare::EncoderDecoders::Base62 base62_encoder;
      return base62_encoder.encode(body_length, 4);
    body_dependency_symbols:
      - AllegroFlare::EncoderDecoders::Base62


  - name: ignore
    body: |
      return;
    body_dependency_symbols:
      - chat_message


dependencies:


  - symbol: chat_message
    headers: [ AllegroFlare/Network2/inc/chat_message.hpp ]
  - symbol: char*
    headers: [ ]
  - symbol: char[16 + 512]
    headers: [ ]
  - symbol: std::size_t
    headers: [ cstddef ]
  - symbol: AllegroFlare::EncoderDecoders::Base62
    headers: [ AllegroFlare/EncoderDecoders/Base62.hpp ]
  - symbol: AllegroFlare::SHA2
    headers: [ AllegroFlare/SHA2.hpp ]


